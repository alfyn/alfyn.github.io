<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="使用RouterOS实现多拨负载均衡"><meta name="keywords" content="network,"><link rel="alternate" href="/default" title="Alfyn"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1"><link rel="canonical" href="https://alfyn.me/posts/92902a84.html"><meta name="description" content="负载均衡负载平衡（Load balancing）是一种计算机技术，用来在多个计算机（计算机集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到最优化资源使用、最大化吞吐率、最小化响应时间、同时避免过载的目的。​ 一般来说，如果运营商不限制多次拨号（例如校园网不限制拨号数），或者多线接入，即可使用多拨技术有效将各个账号的带宽结合起来以提高网络速度。​ RouterOS中提供了多种方式进行"><meta name="keywords" content="network"><meta property="og:type" content="article"><meta property="og:title" content="使用RouterOS实现多拨负载均衡"><meta property="og:url" content="https://alfyn.me/posts/92902a84.html"><meta property="og:site_name" content="Alfyn"><meta property="og:description" content="负载均衡负载平衡（Load balancing）是一种计算机技术，用来在多个计算机（计算机集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到最优化资源使用、最大化吞吐率、最小化响应时间、同时避免过载的目的。​ 一般来说，如果运营商不限制多次拨号（例如校园网不限制拨号数），或者多线接入，即可使用多拨技术有效将各个账号的带宽结合起来以提高网络速度。​ RouterOS中提供了多种方式进行"><meta property="og:locale" content="default"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022191535923.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022191555588.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022191453149.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022191429750.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022192139332.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022192152010.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022195628166.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022195641679.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022195653198.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022200016464.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022200038048.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022200121848.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022200204712.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022200337265.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022200402731.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022200755671.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022200855936.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022201046175.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022201221855.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022201241135.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022201513469.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022201600655.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022201749035.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022201824224.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022202008602.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022202032648.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022202153490.png"><meta property="og:image" content="https://alfyn.me/posts/92902a84/image-20201022202620026.png"><meta property="og:updated_time" content="2020-10-22T12:56:36.437Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="使用RouterOS实现多拨负载均衡"><meta name="twitter:description" content="负载均衡负载平衡（Load balancing）是一种计算机技术，用来在多个计算机（计算机集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到最优化资源使用、最大化吞吐率、最小化响应时间、同时避免过载的目的。​ 一般来说，如果运营商不限制多次拨号（例如校园网不限制拨号数），或者多线接入，即可使用多拨技术有效将各个账号的带宽结合起来以提高网络速度。​ RouterOS中提供了多种方式进行"><meta name="twitter:image" content="https://alfyn.me/posts/92902a84/image-20201022191535923.png"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1"><link href="https://fonts.alfyn.me/css?family=Open+Sans" rel="stylesheet"><script type="text/javascript">var themeConfig={fancybox:{enable:!1}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-145372682-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-145372682-1")</script><title>使用RouterOS实现多拨负载均衡 - Alfyn</title></head><body><div id="page"><header id="masthead"><div class="site-header-inner"><h1 class="site-title"><a href="/." class="logo">Alfyn</a></h1><nav id="nav-top"><ul id="menu-top" class="nav-top-items"><li class="menu-item"><a href="/about">About</a></li></ul></nav></div></header><div id="content"><div id="primary"><article class="post"><header class="post-header"><h1 class="post-title">使用RouterOS实现多拨负载均衡</h1><time class="post-time">Oct 22 2020</time></header><div class="post-content"><h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><blockquote><p>负载平衡（Load balancing）是一种计算机技术，用来在多个计算机（计算机集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到最优化资源使用、最大化吞吐率、最小化响应时间、同时避免过载的目的。</p></blockquote><p>​ 一般来说，如果运营商不限制多次拨号（例如校园网不限制拨号数），或者多线接入，即可使用多拨技术有效将各个账号的带宽结合起来以提高网络速度。</p><p>​ RouterOS中提供了多种方式进行负载均衡：</p><ul><li><p>ECMP（Equal-Cost Multi-path）：ECMP是通过在route列表添加多网关的静态路由，然后由路由协议建立劢态的多线路由。这种负载均衡有个缺点，缺点就是每十分钟内核会重新均衡线路，使一些连接会被指定到其他路线，出现频繁掉线的情况。</p></li><li><p>NTH：NTH是采用第N次链接的负载均衡，它不仅可以实现基于IP的负载均衡，同时还能实现对端口负载均衡和对nat指定有序的访问。这样基本实现了不掉线的真正负载均衡。但是NTH存在着一个弊端，就是在某些对IP要求严格的网站会反复要求验证。比如，网银。这样我们需要通过策略将一些IP或者端口指定走固定的线路出去，从而避开网站繁琐的验证。</p></li><li><p>PCC（Per connection classified）： PCC是通过判断源地址或者目的地址、源端口或者目的端口对数据进行分类来实现负载均衡，对每个连接进行分类大多保持了连续性，这样大大弥补了NTH 的不足。</p></li></ul><h3 id="RouterOS设置"><a href="#RouterOS设置" class="headerlink" title="RouterOS设置"></a>RouterOS设置</h3><p>本文使用RouterOS的vrrp进行单端口三拨，eth-wan1作为wan口，ether2-5为lan口</p><ol><li><p>Interfaces菜单下添加三个vrrp拨号。</p><table><thead><tr><th>Name</th><th>Interface</th><th>VRID</th></tr></thead><tbody><tr><td>vrrp1</td><td>eth-wan1</td><td>1</td></tr><tr><td>vrrp2</td><td>eth-wan1</td><td>2</td></tr><tr><td>vrrp3</td><td>eth-wan1</td><td>3</td></tr></tbody></table><img src="/posts/92902a84/image-20201022191535923.png" title="image-20201022191535923.png"> <img src="/posts/92902a84/image-20201022191555588.png" title="image-20201022191555588.png"></li><li><p>Interfaces菜单下添加三个PPPOE Client，分别填写User和Password，不要勾选Dial On Demand、Use Peer DNS和Add Default Route。</p><table><thead><tr><th>Name</th><th>Interfaces</th></tr></thead><tbody><tr><td>pppoe-out1</td><td>vrrp1</td></tr><tr><td>pppoe-out2</td><td>vrrp2</td></tr><tr><td>pppoe-out3</td><td>vrrp3</td></tr></tbody></table><img src="/posts/92902a84/image-20201022191453149.png" title="image-20201022191453149"> <img src="/posts/92902a84/image-20201022191429750.png" title="image-20201022191429750"></li><li><p>在IP-&gt;Addresses下设置接口的ip地址。</p><table><thead><tr><th>Interface</th><th>Address</th><th>Network</th></tr></thead><tbody><tr><td>eth-wan1</td><td>192.168.100.1/24</td><td>192.168.100.0</td></tr><tr><td>vrrp1</td><td>192.168.100.2/24</td><td>192.168.100.0</td></tr><tr><td>vrrp2</td><td>192.168.100.3/24</td><td>192.168.100.0</td></tr><tr><td>vrrp3</td><td>192.168.100.4/24</td><td>192.168.100.0</td></tr></tbody></table><img src="/posts/92902a84/image-20201022192139332.png" title="image-20201022192139332"> <img src="/posts/92902a84/image-20201022192152010.png" title="image-20201022192152010"></li><li><p>IP-&gt;Firewall-&gt;Mangle下添加Change MSS标记。</p><img src="/posts/92902a84/image-20201022195628166.png" title="image-20201022195628166"> <img src="/posts/92902a84/image-20201022195641679.png" title="image-20201022195641679"> <img src="/posts/92902a84/image-20201022195653198.png" title="image-20201022195653198"></li><li><p>添加三条线路的连接标记和路由标记。PCC设置中，N条线的值分别为N/(0~N-1)。</p><table><thead><tr><th>Chain</th><th>In. Interface</th><th>Per Connection Classifier</th><th>Dst. Address Type</th><th>Action</th><th>New Connection Mark</th></tr></thead><tbody><tr><td>prerouting</td><td>bridge</td><td>both addresses 3/0</td><td>local invert</td><td>mark connection</td><td>PCC_1</td></tr><tr><td>prerouting</td><td>bridge</td><td>both addresses 3/1</td><td>local invert</td><td>mark connection</td><td>PCC_2</td></tr><tr><td>prerouting</td><td>bridge</td><td>both addresses 3/2</td><td>local invert</td><td>mark connection</td><td>PCC_3</td></tr></tbody></table><img src="/posts/92902a84/image-20201022200016464.png" title="image-20201022200016464"> <img src="/posts/92902a84/image-20201022200038048.png" title="image-20201022200038048"> <img src="/posts/92902a84/image-20201022200121848.png" title="image-20201022200121848"> <img src="/posts/92902a84/image-20201022200204712.png" title="image-20201022200204712"><table><thead><tr><th>Chain</th><th>In. Interface</th><th>Connection Mark</th><th>Action</th><th>New Routing Mark</th></tr></thead><tbody><tr><td>prerouting</td><td>bridge</td><td>PCC_1</td><td>mark routing</td><td>PCC_ROUTE1</td></tr><tr><td>prerouting</td><td>bridge</td><td>PCC_2</td><td>mark routing</td><td>PCC_ROUTE2</td></tr><tr><td>prerouting</td><td>bridge</td><td>PCC_3</td><td>mark routing</td><td>PCC_ROUTE3</td></tr></tbody></table><img src="/posts/92902a84/image-20201022200337265.png" title="image-20201022200337265"> <img src="/posts/92902a84/image-20201022200402731.png" title="image-20201022200402731"><p>结果如图：</p><img src="/posts/92902a84/image-20201022200755671.png" title="image-20201022200755671"></li><li><p>IP-&gt;Routes添加路由。</p><table><thead><tr><th>Gateway</th><th>Routing Mark</th></tr></thead><tbody><tr><td>pppoe-out1</td><td>PCC_ROUTE1</td></tr><tr><td>pppoe-out2</td><td>PCC_ROUTE2</td></tr><tr><td>pppoe-out3</td><td>PCC_ROUTE3</td></tr></tbody></table><img src="/posts/92902a84/image-20201022200855936.png" title="image-20201022200855936"><p>再添加三条空路由</p><table><thead><tr><th>Gateway</th><th>Distance</th></tr></thead><tbody><tr><td>pppoe-out1</td><td>1</td></tr><tr><td>pppoe-out2</td><td>2</td></tr><tr><td>pppoe-out3</td><td>3</td></tr></tbody></table><p>结果如图：</p><img src="/posts/92902a84/image-20201022201046175.png" title="image-20201022201046175"></li><li><p>IP-&gt;Firewall-&gt;NAT伪装地址。</p><table><thead><tr><th>Chain</th><th>Out. Interface</th><th>Action</th></tr></thead><tbody><tr><td>srcnat</td><td>pppoe-out1</td><td>masquerade</td></tr><tr><td>srcnat</td><td>pppoe-out2</td><td>masquerade</td></tr><tr><td>srcnat</td><td>pppoe-out3</td><td>masquerade</td></tr></tbody></table><img src="/posts/92902a84/image-20201022201221855.png" title="image-20201022201221855"> <img src="/posts/92902a84/image-20201022201241135.png" title="image-20201022201241135"></li><li><p>IP-&gt;DNS设置Servers为114.114.114.114，223.5.5.5。勾选Allow Remote Requests。</p></li><li><p>IP-&gt;Pool设置IP地址池。</p><img src="/posts/92902a84/image-20201022201513469.png" title="image-20201022201513469"><p>IP-&gt;DHCP Server设置DHCP服务器。</p><img src="/posts/92902a84/image-20201022201600655.png" title="image-20201022201600655"></li><li><p>IP-&gt;Firewall-&gt;Mangle中设置input和output路径。</p><table><thead><tr><th>Chain</th><th>In. Interface</th><th>Action</th><th>New Connection Mark</th></tr></thead><tbody><tr><td>input</td><td>pppoe-out1</td><td>mark connection</td><td>PCC_1</td></tr><tr><td>input</td><td>pppoe-out2</td><td>mark connection</td><td>PCC_2</td></tr><tr><td>input</td><td>pppoe-out3</td><td>mark connection</td><td>PCC_3</td></tr></tbody></table><img src="/posts/92902a84/image-20201022201749035.png" title="image-20201022201749035"> <img src="/posts/92902a84/image-20201022201824224.png" title="image-20201022201824224"><table><thead><tr><th>Chain</th><th>Connection Mark</th><th>Action</th><th>New Routing Mark</th></tr></thead><tbody><tr><td>output</td><td>PCC_1</td><td>mark routing</td><td>PCC_ROUTE1</td></tr><tr><td>output</td><td>PCC_2</td><td>mark routing</td><td>PCC_ROUTE2</td></tr><tr><td>output</td><td>PCC_3</td><td>mark routing</td><td>PCC_ROUTE3</td></tr></tbody></table><img src="/posts/92902a84/image-20201022202008602.png" title="image-20201022202008602"> <img src="/posts/92902a84/image-20201022202032648.png" title="image-20201022202032648"><p>把出入口标记拖到MSS下面。</p><img src="/posts/92902a84/image-20201022202153490.png" title="image-20201022202153490"></li></ol><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>只有部分支持多线程的下载软件可以同时利用多路速度，例如百度网盘、迅雷等。</p><img src="/posts/92902a84/image-20201022202620026.png" title="image-20201022202620026"><p>可以看到，三条线均达到了我这里的理论带宽（20~30M），叠加后的速度为70M。</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/network/">network</a></div><nav class="post-nav"><a class="next" href="/posts/5f927b76.html"><span class="next-text nav-default">独立服务器使用PVE创建KVM虚拟机</span> <span class="prev-text nav-mobile">Next</span> <i class="iconfont icon-right"></i></a></nav><div class="comments" id="comments"></div></footer></article></div></div><footer id="colophon"><span class="copyright-year">&copy; 2019 - 2021 <span class="footer-author">Alfyn.</span> <span class="power-by">Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/henryhuang/hexo-theme-polarbearsimple">Polar Bear Simple</a></span></span></footer><div class="back-to-top" id="back-to-top"><i class="iconfont icon-up"></i></div></div><script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script><script type="text/javascript" src="/js/src/theme.js?v=1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script></body></html>