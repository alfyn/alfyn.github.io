<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="独立服务器使用PVE创建KVM虚拟机"><meta name="keywords" content="kvm,pve,linux,"><link rel="alternate" href="/default" title="Alfyn"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1"><link rel="canonical" href="https://alfyn.me/posts/5f927b76.html"><meta name="description" content="最近搞到了几台独立服务器（未经虚拟化过的独立CPU，内存等，下称独服），并且服务上分配了5个ip到此服务器上。在独服上只安装个ubuntu之类的单个操作系统感觉有点浪费了多了ip和性能，于是决定在独服基础上新建KVM虚拟机分别装系统来充分利用ip，同时便于资源的管理。准备环境网络：假设主ip为1.2.3.98，可用ip为1.2.3.99，1.2.3.100，1.2.3.101，1.2.3.102，"><meta name="keywords" content="kvm,pve,linux"><meta property="og:type" content="article"><meta property="og:title" content="独立服务器使用PVE创建KVM虚拟机"><meta property="og:url" content="https://alfyn.me/posts/5f927b76.html"><meta property="og:site_name" content="Alfyn"><meta property="og:description" content="最近搞到了几台独立服务器（未经虚拟化过的独立CPU，内存等，下称独服），并且服务上分配了5个ip到此服务器上。在独服上只安装个ubuntu之类的单个操作系统感觉有点浪费了多了ip和性能，于是决定在独服基础上新建KVM虚拟机分别装系统来充分利用ip，同时便于资源的管理。准备环境网络：假设主ip为1.2.3.98，可用ip为1.2.3.99，1.2.3.100，1.2.3.101，1.2.3.102，"><meta property="og:locale" content="default"><meta property="og:image" content="https://alfyn.me/posts/5f927b76/hdd_setting.png"><meta property="og:image" content="https://alfyn.me/posts/5f927b76/cpu_numa.png"><meta property="og:updated_time" content="2020-05-11T11:50:08.115Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="独立服务器使用PVE创建KVM虚拟机"><meta name="twitter:description" content="最近搞到了几台独立服务器（未经虚拟化过的独立CPU，内存等，下称独服），并且服务上分配了5个ip到此服务器上。在独服上只安装个ubuntu之类的单个操作系统感觉有点浪费了多了ip和性能，于是决定在独服基础上新建KVM虚拟机分别装系统来充分利用ip，同时便于资源的管理。准备环境网络：假设主ip为1.2.3.98，可用ip为1.2.3.99，1.2.3.100，1.2.3.101，1.2.3.102，"><meta name="twitter:image" content="https://alfyn.me/posts/5f927b76/hdd_setting.png"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1"><link href="https://fonts.alfyn.me/css?family=Open+Sans" rel="stylesheet"><script type="text/javascript">var themeConfig={fancybox:{enable:!1}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-145372682-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-145372682-1")</script><title>独立服务器使用PVE创建KVM虚拟机 - Alfyn</title></head><body><div id="page"><header id="masthead"><div class="site-header-inner"><h1 class="site-title"><a href="/." class="logo">Alfyn</a></h1><nav id="nav-top"><ul id="menu-top" class="nav-top-items"><li class="menu-item"><a href="/about">About</a></li></ul></nav></div></header><div id="content"><div id="primary"><article class="post"><header class="post-header"><h1 class="post-title">独立服务器使用PVE创建KVM虚拟机</h1><time class="post-time">Apr 14 2020</time></header><div class="post-content"><p>最近搞到了几台独立服务器（未经虚拟化过的独立CPU，内存等，下称独服），并且服务上分配了5个ip到此服务器上。在独服上只安装个ubuntu之类的单个操作系统感觉有点浪费了多了ip和性能，于是决定在独服基础上新建KVM虚拟机分别装系统来充分利用ip，同时便于资源的管理。</p><h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h3><p>网络：假设主ip为1.2.3.98，可用ip为1.2.3.99，1.2.3.100，1.2.3.101，1.2.3.102，网关为1.2.3.97，掩码为255.255.255.248（其他自己计算）。<br>独服环境：基础操作系统为Debian9。<br>虚拟化软件：Proxmox VE</p><blockquote><p>Proxmox VE（英语：Proxmox Virtual Environment，通常简称为PVE、Proxmox），是一个开源的服务器虚拟化环境Linux发行版。Proxmox VE基于Debian，使用基于Ubuntu的定制内核，包含安装程序、网页控制台和命令行工具，并且向第三方工具提供了REST API，在Affero通用公共许可证第三版下发行。Proxmox VE支持两类虚拟化技术：基于容器的LXC（自4.0版开始，3.4版及以前使用OpenVZ技术）和硬件抽象层全虚拟化的KVM。<br>检查Bios是否开启了虚拟化（不然没法启动虚拟机系统）：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lsmod |grep kvm</span><br><span class="line"><span class="comment"># 输出结果：</span></span><br><span class="line"><span class="comment"># 未开启</span></span><br><span class="line">kvm 554609 0</span><br><span class="line">irqbypass 13503 1 kvm</span><br><span class="line"><span class="comment"># 已开启</span></span><br><span class="line">kvm_intel 170181 0</span><br><span class="line">kvm 554609 1 kvm_intel</span><br><span class="line">irqbypass 13503 1 kvm</span><br></pre></td></tr></table></figure><h3 id="安装PVE"><a href="#安装PVE" class="headerlink" title="安装PVE"></a>安装PVE</h3><p><a href="https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_Stretch" title="PVE_install" target="_blank" rel="noopener">安装pve官方文档</a></p><ul><li><p>设置hostname</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl <span class="built_in">set</span>-hostname usdedi</span><br></pre></td></tr></table></figure></li><li><p>修改hosts</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"><span class="comment"># 修改为ip(公网) hostname，如</span></span><br><span class="line">1.2.3.98 usdedi</span><br></pre></td></tr></table></figure></li><li><p>检查名称</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hostname --ip-address</span><br><span class="line"><span class="comment"># 需要输出你的ip地址</span></span><br></pre></td></tr></table></figure></li><li><p>安装<br>如果上面都没有问题，那么可以开始安装了，安装完成重启系统。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"deb http://download.proxmox.com/debian/pve stretch pve-no-subscription"</span> &gt; /etc/apt/sources.list.d/pve-install-repo.list</span><br><span class="line">wget http://download.proxmox.com/debian/proxmox-ve-release-5.x.gpg -O /etc/apt/trusted.gpg.d/proxmox-ve-release-5.x.gpg</span><br><span class="line">chmod +r /etc/apt/trusted.gpg.d/proxmox-ve-release-5.x.gpg</span><br><span class="line">apt update &amp;&amp; apt dist-upgrade</span><br><span class="line">apt install proxmox-ve postfix open-iscsi</span><br></pre></td></tr></table></figure></li></ul><h3 id="设置网络"><a href="#设置网络" class="headerlink" title="设置网络"></a>设置网络</h3><p><strong>重要</strong>，如果网络设置不正确并且独服没有提供vnc功能，重启网络后会再也不能连上独服。可以编写脚本每次重启时自动恢复初始网络配置来避免设置出错导致的失联。<br><a href="https://pve.proxmox.com/wiki/Network_Configuration" title="PVE_network" target="_blank" rel="noopener">网络设置官方文档</a><br><strong>重要</strong>，根据官方文档中的说法，如果不按服务商规定桥接网络会导致断网。</p><blockquote><p>Most hosting providers do not support the above setup. For security reasons, they disable networking as soon as they detect multiple MAC addresses on a single interface.</p></blockquote><p>由于我的服务商没有禁止多MAC桥接到同一端口，故采取默认方法，配置如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="comment"># and how to activate them. For more information, see interfaces(5).</span></span><br><span class="line"><span class="built_in">source</span> /etc/network/interfaces.d/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># The loopback network interface</span></span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line"><span class="comment"># The primary network interface</span></span><br><span class="line">iface enp4s0 inet manual</span><br><span class="line"><span class="comment"># 这里是你的物理网卡</span></span><br><span class="line"></span><br><span class="line">auto vmbr0</span><br><span class="line">iface vmbr0 inet static</span><br><span class="line">        address 1.2.3.98/29</span><br><span class="line">        gateway 1.2.3.97</span><br><span class="line">        <span class="comment"># 自己算</span></span><br><span class="line">        <span class="comment"># dns-* options are implemented by the resolvconf package, if installed</span></span><br><span class="line">        dns-nameservers 127.0.0.1</span><br><span class="line">        dns-search 32918</span><br><span class="line">        bridge_ports enp4s0</span><br><span class="line">        <span class="comment"># 这里是你的物理网卡</span></span><br><span class="line">        bridge_stp off</span><br><span class="line">        bridge_fd 0</span><br><span class="line"></span><br><span class="line">auto vmbr1</span><br><span class="line">iface vmbr1 inet static</span><br><span class="line">        address 10.0.0.1</span><br><span class="line">        netmask 255.255.255.0</span><br><span class="line">        <span class="comment"># 这里自己选个内网ip段吧</span></span><br><span class="line">        bridge_ports none</span><br><span class="line">        <span class="comment"># 这里没有桥接到物理网卡</span></span><br><span class="line">        bridge_stp off</span><br><span class="line">        bridge_fd 0</span><br><span class="line">        post-up <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">        post-up iptables -t nat -A POSTROUTING -s <span class="string">'10.0.0.0/24'</span> -o vmbr0 -j MASQUERADE</span><br><span class="line">        post-down iptables -t nat -D POSTROUTING -s <span class="string">'10.0.0.0/24'</span> -o vmbr0 -j MASQUERADE</span><br></pre></td></tr></table></figure><p>上面的设置创建了如下的网络：</p><ol><li>如果虚拟机连接到vmbr0，则需要为其分配公网ip地址则可以访问网络；</li><li>如果虚拟机连接到vmbr1，则需要为其分配内网ip地址通过独服宿主机访问网络。</li></ol><p>最后重启主机。（单独重启网络需要手动停止和启动vmbr，停止后会导致ssh断开没法再连接上，还是直接重启机器吧）</p><h3 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h3><p>将系统iso镜像下载到</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/vz/template/iso</span><br></pre></td></tr></table></figure><p>目录中。之后在web管理界面<code>https://ip:8006</code>中创建虚拟机一步一步按流程来就行了，注意根据网卡选择不同需要手动设置不同的静态ip。</p><h3 id="一些小问题"><a href="#一些小问题" class="headerlink" title="一些小问题"></a>一些小问题</h3><ul><li><p>如果是HDD磁盘，感觉创建后的虚拟机磁盘IO会进一步降低，这里创建时将其改为VirtIO Block和Write Back(不安全)，可以提高io，具体区别和风险自行查阅。</p><img src="/posts/5f927b76/hdd_setting.png" title="hdd_setting"></li><li><p>CPU高级设置中勾选启用NUMA，虽然我感觉不到有什么用（</p><img src="/posts/5f927b76/cpu_numa.png" title="cpu_numa"></li><li><p>如果要安装windows系统，需要下载VirtIO驱动并作为第二光驱挂载，安装时手动加载驱动程序便可找到磁盘并且在开机后安装网卡驱动。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso</span><br></pre></td></tr></table></figure></li><li><p>禁止公网访问PVE控制页面</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 127.0.0.1 -p tcp --dport 8006 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p TCP --dport 8006 -j REJECT</span><br></pre></td></tr></table></figure></li><li><p>关闭登录后的订阅提醒</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js</span><br><span class="line"><span class="comment"># 搜索并修改if(data.status!=='Active') 为if(false)即可。</span></span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/kvm/">kvm</a> <a href="/tags/pve/">pve</a> <a href="/tags/linux/">linux</a></div><nav class="post-nav"><a class="prev" href="/posts/92902a84.html"><i class="iconfont icon-left"></i> <span class="prev-text nav-default">使用RouterOS实现多拨负载均衡</span> <span class="prev-text nav-mobile">Prev</span> </a><a class="next" href="/posts/360c728e.html"><span class="next-text nav-default">使用GRE隧道路由流量</span> <span class="prev-text nav-mobile">Next</span> <i class="iconfont icon-right"></i></a></nav><div class="comments" id="comments"></div></footer></article></div></div><footer id="colophon"><span class="copyright-year">&copy; 2019 - 2021 <span class="footer-author">Alfyn.</span> <span class="power-by">Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/henryhuang/hexo-theme-polarbearsimple">Polar Bear Simple</a></span></span></footer><div class="back-to-top" id="back-to-top"><i class="iconfont icon-up"></i></div></div><script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script><script type="text/javascript" src="/js/src/theme.js?v=1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script></body></html>